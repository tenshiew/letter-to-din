<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>письмо тебе</title>
  <link rel="stylesheet" href="style.css">

  <script src="bundle.js"></script>
</head>
<body>

  <div class="wrap">

    <main id="letter" class="hidden"></main>

    <div id="gate" class="gate">
      <div class="gate-box">
        <div class="gate-title">введи пароль</div>
        <input id="pass" type="password" placeholder="••••••" autocomplete="off" />
        <div class="gate-actions">
          <button id="ok">открыть</button>
        </div>
        <div id="hint" class="hint">у тебя много подсказок, но CTRL + U это не выход</div>
      </div>
    </div>

  </div>

  <script>

    const b642ab = s => Uint8Array.from(atob(s), c=>c.charCodeAt(0));
    const ab2str = ab => new TextDecoder().decode(ab);

    function sanitizeHtml(html) {
      html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
      html = html.replace(/\s*on\w+\s*=\s*(["'])[^\1]*?\1/gi, '');
      return html;
    }

    async function deriveKey(password, salt) {
      const base = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name:'PBKDF2', salt, iterations:150000, hash:'SHA-256'},
        base,
        {name:'AES-GCM', length:256},
        false,
        ['decrypt']
      );
    }

    async function decryptText(password, bundle) {
      if(!bundle || typeof bundle !== 'string') throw new Error('cipherBundle отсутствует или некорректен');
      const parts = bundle.split('.');
      if(parts.length !== 3) throw new Error('cipherBundle в неправильном формате (ожидается salt.iv.cipher)');
      const salt = b642ab(parts[0]);
      const iv = b642ab(parts[1]);
      const cipher = b642ab(parts[2]);

      const key = await deriveKey(password, salt);
      const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, cipher);
      return ab2str(plain);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const gate = document.getElementById('gate');
      const input = document.getElementById('pass');
      const btn = document.getElementById('ok');
      const letter = document.getElementById('letter');

      if(!gate || !input || !btn || !letter) {
        console.error('Элемент не найден: gate/pass/ok/letter. Проверь id.');
        return;
      }

      function openFail() {
        gate.classList.add('shake');
        setTimeout(()=> gate.classList.remove('shake'), 600);
        input.value = '';
        input.focus();
      }

      async function handleOpen() {
        const pw = input.value;
        if(!pw) { openFail(); return; }
        try {
          const decrypted = await decryptText(pw, cipherBundle);
          const safe = sanitizeHtml(decrypted);
          letter.innerHTML = safe;
          gate.style.display = 'none';
          letter.classList.remove('hidden');
          document.title = 'письмо открыто';
        } catch (err) {
          console.error('Ошибка дешифровки:', err);
          openFail();
        }
      }

      btn.addEventListener('click', handleOpen);
      input.addEventListener('keydown', e => { if(e.key === 'Enter') handleOpen(); });

      if(!cipherBundle || cipherBundle.trim().length < 10) {
        console.warn('cipherBundle пуст или короткий — убедись, что bundle.js подключен и содержит строку.');
      }
    });
  </script>

</body>
</html>










